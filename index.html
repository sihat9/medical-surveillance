<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Surveillance System</title>
    <style>
        /* COMPLETE CSS SYSTEM */
        :root {
            --primary: #2E7D32;
            --primary-dark: #1B5E20;
            --primary-light: #4CAF50;
            --secondary: #1565C0;
            --accent: #FF8F00;
            --danger: #C62828;
            --warning: #F57C00;
            --success: #388E3C;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-600: #6c757d;
            --gray-800: #343a40;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        /* SCREEN MANAGEMENT */
        .screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }

        .screen.active {
            display: block;
        }

        /* HEADER & NAVIGATION */
        .header {
            background: white;
            box-shadow: var(--shadow);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-radius: var(--radius);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo h1 {
            color: var(--primary);
            font-size: 1.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* LOGIN SCREEN */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* DASHBOARDS */
        .dashboard {
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--gray-100);
            padding: 1.5rem;
            border-radius: var(--radius);
            border-left: 4px solid var(--primary);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        /* FORMS */
        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-800);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        /* BUTTONS */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* TABLES */
        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background: var(--gray-100);
            font-weight: 600;
            color: var(--gray-800);
        }

        tr:hover {
            background: var(--gray-100);
        }

        /* STATUS BADGES */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-in-progress { background: #d1edff; color: #004085; }
        .status-abnormal { background: #f8d7da; color: #721c24; }

        /* SIGNATURE CANVAS */
        .signature-container {
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius);
            padding: 1rem;
            background: white;
        }

        .signature-canvas {
            border: 1px solid var(--gray-300);
            background: white;
            cursor: crosshair;
            touch-action: none;
        }

        /* LAB DUAL-VIEW */
        .lab-dual-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            height: 600px;
        }

        .lab-pdf-view, .lab-input-view {
            background: white;
            border-radius: var(--radius);
            padding: 1rem;
            box-shadow: var(--shadow);
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .lab-dual-view {
                grid-template-columns: 1fr;
                height: auto;
            }

            .screen {
                padding: 10px;
            }
        }

        /* LOADING & ALERTS */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* QR SCANNER */
        .qr-scanner {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }

        .qr-video {
            width: 100%;
            border-radius: var(--radius);
            border: 2px solid var(--primary);
        }

        /* CHECKBOX STYLES */
        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        /* PHYSICAL EXAMINATION GRID */
        .exam-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        /* DEMO BADGE */
        .demo-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--warning);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="demo-badge">DEMO MODE</div>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="screen active">
        <div class="login-container">
            <div class="logo" style="justify-content: center; margin-bottom: 2rem;">
                <h1>üè• Medical Surveillance System</h1>
            </div>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="klinikSelect">Pilih Klinik</label>
                    <select id="klinikSelect" required>
                        <option value="">-- Pilih Klinik --</option>
                        <option value="KLINIK_001">Klinik Kesihatan Utama</option>
                        <option value="KLINIK_002">Klinik Kesihatan Cemerlang</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="cth: admin@klinik.com" required>
                </div>

                <div class="form-group">
                    <label for="password">Kata Laluan</label>
                    <input type="password" id="password" placeholder="Masukkan kata laluan" required>
                </div>

                <div class="form-group">
                    <label for="roleSelect">Jenis Pengguna</label>
                    <select id="roleSelect" required>
                        <option value="">-- Pilih Peranan --</option>
                        <option value="admin">Admin (Super Admin)</option>
                        <option value="doctor">Doktor</option>
                        <option value="ma">Pembantu Perubatan (MA)</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <span id="loginText">Log Masuk</span>
                    <span id="loginLoading" class="loading" style="display: none;"></span>
                </button>
            </form>

            <div style="margin-top: 1rem; text-align: center;">
                <p style="color: var(--gray-600); font-size: 0.875rem;">
                    üí° <strong>Demo Credentials:</strong><br>
                    Admin: admin@klinik.com / mana-mana password<br>
                    Doctor: doctor@klinik.com / mana-mana password<br>
                    MA: ma@klinik.com / mana-mana password
                </p>
            </div>

            <div id="loginAlert" style="margin-top: 1rem;"></div>
        </div>
    </div>

    <!-- SUPER ADMIN DASHBOARD -->
    <div id="superAdminDashboard" class="screen">
        <div class="header">
            <div class="logo">
                <h1>üè• Medical Surveillance - Super Admin</h1>
            </div>
            <div class="user-info">
                <span id="adminUserName">Loading...</span>
                <button onclick="logout()" class="btn btn-outline">Log Keluar</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalKlinik">3</div>
                    <div>Jumlah Klinik</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSessions">12</div>
                    <div>Sessions Aktif</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalWorkers">1,247</div>
                    <div>Jumlah Pekerja</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completionRate">78%</div>
                    <div>Kadar Penyiapan</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <h3>Sessions Terkini</h3>
                    <div class="table-container">
                        <table id="sessionsTable">
                            <thead>
                                <tr>
                                    <th>Nama Session</th>
                                    <th>Klinik</th>
                                    <th>Status</th>
                                    <th>Tindakan</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Medical Surveillance 2024</td>
                                    <td>Klinik Utama</td>
                                    <td><span class="status-badge status-in-progress">IN PROGRESS</span></td>
                                    <td><button class="btn btn-primary btn-sm">View</button></td>
                                </tr>
                                <tr>
                                    <td>Health Screening Q1 2024</td>
                                    <td>Klinik Cemerlang</td>
                                    <td><span class="status-badge status-completed">COMPLETED</span></td>
                                    <td><button class="btn btn-primary btn-sm">View</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div>
                    <h3>Tindakan Pantas</h3>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <button onclick="showScreen('sessionSelectionScreen')" class="btn btn-primary">
                            üìÖ Urus Sessions
                        </button>
                        <button onclick="createNewSession()" class="btn btn-secondary">
                            üÜï Session Baru
                        </button>
                        <button onclick="showScreen('userManagementScreen')" class="btn btn-success">
                            üë• Urus Pengguna
                        </button>
                        <button onclick="generateSystemReport()" class="btn btn-outline">
                            üìä Laporan Sistem
                        </button>
                    </div>

                    <div style="margin-top: 2rem; padding: 1rem; background: var(--gray-100); border-radius: var(--radius);">
                        <h4>System Info</h4>
                        <p style="font-size: 0.875rem; color: var(--gray-600);">
                            <strong>Backend:</strong> <span id="backendStatus">Checking...</span><br>
                            <strong>Database:</strong> <span id="databaseStatus">Checking...</span><br>
                            <strong>Storage:</strong> <span id="storageStatus">Checking...</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SESSION SELECTION SCREEN -->
    <div id="sessionSelectionScreen" class="screen">
        <div class="header">
            <div class="logo">
                <h1>üè• Pilih Session</h1>
            </div>
            <div class="user-info">
                <span id="sessionUserRole"></span>
                <button onclick="logout()" class="btn btn-outline">Log Keluar</button>
            </div>
        </div>

        <div class="dashboard">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 2rem;">
                <h2>Pilih Session Medical Surveillance</h2>
                <button onclick="createNewSession()" class="btn btn-primary">+ Session Baru</button>
            </div>

            <div class="table-container">
                <table id="sessionsListTable">
                    <thead>
                        <tr>
                            <th>Nama Session</th>
                            <th>Syarikat</th>
                            <th>Tarikh</th>
                            <th>Status</th>
                            <th>Pekerja</th>
                            <th>Kemajuan</th>
                            <th>Tindakan</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Sessions will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MA DASHBOARD -->
    <div id="maDashboard" class="screen">
        <div class="header">
            <div class="logo">
                <h1>üë®‚Äç‚öïÔ∏è Medical Assistant Dashboard</h1>
            </div>
            <div class="user-info">
                <span>Session: <span id="currentSessionName">Medical Surveillance 2024</span></span>
                <button onclick="showScreen('sessionSelectionScreen')" class="btn btn-outline">Tukar Session</button>
                <button onclick="logout()" class="btn btn-outline">Log Keluar</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="maTotalWorkers">0</div>
                    <div>Jumlah Pekerja</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="maPendingVitals">0</div>
                    <div>Pemeriksaan Tertunggak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="maCompletedVitals">0</div>
                    <div>Pemeriksaan Selesai</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="maLabPending">0</div>
                    <div>Lab Tertunggak</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                <div>
                    <h3>Senarai Pekerja</h3>
                    <div class="table-container">
                        <table id="maWorkersTable">
                            <thead>
                                <tr>
                                    <th>Nama</th>
                                    <th>No. KP</th>
                                    <th>Jawatan</th>
                                    <th>Status</th>
                                    <th>Vital Signs</th>
                                    <th>Lab</th>
                                    <th>Tindakan</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Workers will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div>
                    <h3>Tindakan Pantas</h3>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <button onclick="showVitalSignsScreen()" class="btn btn-primary">
                            üíì Input Vital Signs
                        </button>
                        <button onclick="showLabReviewScreen()" class="btn btn-secondary">
                            üß™ Review Lab Results
                        </button>
                        <button onclick="showBulkUploadScreen()" class="btn btn-success">
                            üìÅ Bulk Upload Data
                        </button>
                        <button onclick="exportMAReport()" class="btn btn-outline">
                            üìÑ Export Laporan
                        </button>
                    </div>

                    <div style="margin-top: 2rem; padding: 1rem; background: var(--gray-100); border-radius: var(--radius);">
                        <h4>Session Info</h4>
                        <p style="font-size: 0.875rem; color: var(--gray-600);">
                            <strong>Tarikh:</strong> 15-20 Jan 2024<br>
                            <strong>Lokasi:</strong> Dewan Serbaguna<br>
                            <strong>Ketua MA:</strong> Anda<br>
                            <strong>Status:</strong> Active
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VITAL SIGNS SCREEN -->
    <div id="vitalSignsScreen" class="screen">
        <div class="header">
            <div class="logo">
                <h1>üíì Pemeriksaan Vital Signs</h1>
            </div>
            <div class="user-info">
                <button onclick="showScreen('maDashboard')" class="btn btn-outline">Kembali ke Dashboard</button>
            </div>
        </div>

        <div class="dashboard">
            <form id="vitalSignsForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h3>Maklumat Asas</h3>
                        <div class="form-group">
                            <label for="workerSelect">Pilih Pekerja *</label>
                            <select id="workerSelect" required>
                                <option value="">-- Pilih Pekerja --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="examDate">Tarikh Pemeriksaan *</label>
                            <input type="date" id="examDate" required>
                        </div>
                        <div class="form-group">
                            <label for="examTime">Masa Pemeriksaan *</label>
                            <input type="time" id="examTime" required>
                        </div>
                    </div>

                    <div>
                        <h3>Vital Signs</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="vitalTinggi">Tinggi (cm) *</label>
                                <input type="number" id="vitalTinggi" step="0.1" min="100" max="250" required>
                            </div>
                            <div class="form-group">
                                <label for="vitalBerat">Berat (kg) *</label>
                                <input type="number" id="vitalBerat" step="0.1" min="30" max="200" required>
                            </div>
                            <div class="form-group">
                                <label for="vitalBpSistolik">BP Sistolik *</label>
                                <input type="number" id="vitalBpSistolik" min="60" max="200" required>
                            </div>
                            <div class="form-group">
                                <label for="vitalBpDiastolik">BP Diastolik *</label>
                                <input type="number" id="vitalBpDiastolik" min="40" max="120" required>
                            </div>
                            <div class="form-group">
                                <label for="vitalPulse">Pulse Rate (bpm) *</label>
                                <input type="number" id="vitalPulse" min="40" max="180" required>
                            </div>
                            <div class="form-group">
                                <label for="vitalSpo2">SpO2 (%) *</label>
                                <input type="number" id="vitalSpo2" min="80" max="100" required>
                            </div>
                            <div class="form-group">
                                <label for="vitalSuhu">Suhu (¬∞C)</label>
                                <input type="number" id="vitalSuhu" step="0.1" min="35" max="42" value="37.0">
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 2rem;">
                    <h3>Pemeriksaan Fizikal</h3>
                    <div class="exam-grid">
                        <div class="form-group">
                            <label for="mataVisualAcuityKanan">Mata - Visual Acuity Kanan</label>
                            <input type="text" id="mataVisualAcuityKanan" placeholder="6/6">
                        </div>
                        <div class="form-group">
                            <label for="mataVisualAcuityKiri">Mata - Visual Acuity Kiri</label>
                            <input type="text" id="mataVisualAcuityKiri" placeholder="6/6">
                        </div>
                        <div class="form-group">
                            <label for="mataIshiharaTest">Mata - Ishihara Test</label>
                            <select id="mataIshiharaTest">
                                <option value="">-- Pilih Status --</option>
                                <option value="NORMAL">Normal</option>
                                <option value="COLOR_DEFICIENT">Color Deficient</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tiangBunyiKanan">Telinga - Bunyi Kanan</label>
                            <select id="tiangBunyiKanan">
                                <option value="">-- Pilih Status --</option>
                                <option value="NORMAL">Normal</option>
                                <option value="ABNORMAL">Abnormal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tiangBunyiKiri">Telinga - Bunyi Kiri</label>
                            <select id="tiangBunyiKiri">
                                <option value="">-- Pilih Status --</option>
                                <option value="NORMAL">Normal</option>
                                <option value="ABNORMAL">Abnormal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="paruPemeriksaan">Paru-paru</label>
                            <select id="paruPemeriksaan">
                                <option value="">-- Pilih Status --</option>
                                <option value="NORMAL">Normal</option>
                                <option value="ABNORMAL">Abnormal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="jantungPemeriksaan">Jantung</label>
                            <select id="jantungPemeriksaan">
                                <option value="">-- Pilih Status --</option>
                                <option value="NORMAL">Normal</option>
                                <option value="ABNORMAL">Abnormal</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="physicalExamNotes">Catatan Pemeriksaan Fizikal</label>
                        <textarea id="physicalExamNotes" rows="3" placeholder="Catatan tambahan pemeriksaan fizikal..."></textarea>
                    </div>
                </div>

                <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" onclick="showScreen('maDashboard')" class="btn btn-outline">Batal</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="vitalSaveText">Simpan Vital Signs</span>
                        <span id="vitalSaveLoading" class="loading" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- LAB REVIEW SCREEN -->
    <div id="labReviewScreen" class="screen">
        <div class="header">
            <div class="logo">
                <h1>üß™ Semakan Keputusan Makmal</h1>
            </div>
            <div class="user-info">
                <button onclick="showScreen('maDashboard')" class="btn btn-outline">Kembali ke Dashboard</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="lab-dual-view">
                <div class="lab-pdf-view">
                    <h3>PDF Lab Report</h3>
                    <div style="border: 2px dashed #ccc; padding: 2rem; text-align: center; margin-bottom: 1rem;">
                        <p>Upload PDF Lab Report</p>
                        <input type="file" id="labPdfUpload" accept=".pdf" style="margin: 1rem 0;">
                        <button onclick="uploadLabPDF()" class="btn btn-primary">Upload PDF</button>
                    </div>
                    <div id="pdfViewer" style="height: 400px; border: 1px solid #ccc; display: none;">
                        <div style="padding: 2rem; text-align: center;">
                            <h4>üìÑ Lab Report Preview</h4>
                            <p>PDF akan dipaparkan di sini</p>
                        </div>
                    </div>
                </div>

                <div class="lab-input-view">
                    <h3>Input Keputusan Makmal</h3>
                    <form id="labResultsForm">
                        <div class="form-group">
                            <label for="labWorkerSelect">Pilih Pekerja *</label>
                            <select id="labWorkerSelect" required>
                                <option value="">-- Pilih Pekerja --</option>
                            </select>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="labHb">Hemoglobin (g/dL)</label>
                                <input type="number" id="labHb" step="0.1" min="0" max="20">
                            </div>
                            <div class="form-group">
                                <label for="labWbc">WBC (√ó10‚Åπ/L)</label>
                                <input type="number" id="labWbc" step="0.1" min="0" max="50">
                            </div>
                            <div class="form-group">
                                <label for="labPlatelet">Platelet (√ó10‚Åπ/L)</label>
                                <input type="number" id="labPlatelet" min="0" max="1000">
                            </div>
                            <div class="form-group">
                                <label for="labFbs">FBS (mmol/L)</label>
                                <input type="number" id="labFbs" step="0.1" min="0" max="20">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="labKategori">Kategori Keputusan *</label>
                            <select id="labKategori" required>
                                <option value="">-- Pilih Kategori --</option>
                                <option value="NORMAL">NORMAL</option>
                                <option value="ABNORMAL (OHD)">ABNORMAL (OHD)</option>
                                <option value="ABNORMAL (MEDICAL)">ABNORMAL (MEDICAL)</option>
                                <option value="TIDAK PASTI">TIDAK PASTI</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="labRemarks">Remarks</label>
                            <textarea id="labRemarks" rows="3" placeholder="Catatan tambahan mengenai keputusan makmal..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <span id="labSaveText">Simpan Keputusan Makmal</span>
                            <span id="labSaveLoading" class="loading" style="display: none;"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- DOCTOR DASHBOARD -->
    <div id="doctorDashboard" class="screen">
        <div class="header">
            <div class="logo">
                <h1>üë®‚Äç‚öïÔ∏è Doctor Dashboard</h1>
            </div>
            <div class="user-info">
                <span>Session: <span id="doctorSessionName">Medical Surveillance 2024</span></span>
                <span>Doctor: <span id="doctorName">Loading...</span></span>
                <button onclick="showScreen('sessionSelectionScreen')" class="btn btn-outline">Tukar Session</button>
                <button onclick="logout()" class="btn btn-outline">Log Keluar</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="doctorTotalWorkers">0</div>
                    <div>Jumlah Pekerja</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="doctorPendingReview">0</div>
                    <div>Pemeriksaan Tertunggak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="doctorCompletedReview">0</div>
                    <div>Pemeriksaan Selesai</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="doctorAbnormalCases">0</div>
                    <div>Kes Abnormal</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                <div>
                    <h3>Senarai Pekerja untuk Pemeriksaan</h3>
                    <div class="table-container">
                        <table id="doctorWorkersTable">
                            <thead>
                                <tr>
                                    <th>Nama</th>
                                    <th>No. KP</th>
                                    <th>Vital Signs</th>
                                    <th>Lab Results</th>
                                    <th>Status</th>
                                    <th>Tindakan</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Workers for doctor review will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div>
                    <h3>Tindakan Pantas</h3>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <button onclick="startUSECHHForm()" class="btn btn-primary">
                            üìù Isi Borang USECHH
                        </button>
                        <button onclick="generateMedicalReport()" class="btn btn-secondary">
                            üìÑ Generate Laporan
                        </button>
                        <button onclick="reviewAbnormalCases()" class="btn btn-danger">
                            üö® Semak Kes Abnormal
                        </button>
                        <button onclick="exportDoctorReport()" class="btn btn-success">
                            üìä Export Laporan Doktor
                        </button>
                    </div>

                    <div style="margin-top: 2rem; padding: 1rem; background: var(--gray-100); border-radius: var(--radius);">
                        <h4>Doctor Tools</h4>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button onclick="showDigitalSignature()" class="btn btn-outline btn-sm">
                                ‚úçÔ∏è Tandatangan Digital
                            </button>
                            <button onclick="showQRGenerator()" class="btn btn-outline btn-sm">
                                üì± QR Code Generator
                            </button>
                            <button onclick="showTemplateManager()" class="btn btn-outline btn-sm">
                                üìã Template Manager
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- USECHH FORM SCREEN -->
    <div id="usechhFormScreen" class="screen">
        <div class="header">
            <div class="logo">
                <h1>üìù Borang USECHH - Pemeriksaan Doktor</h1>
            </div>
            <div class="user-info">
                <button onclick="showScreen('doctorDashboard')" class="btn btn-outline">Kembali ke Dashboard</button>
            </div>
        </div>

        <div class="dashboard">
            <form id="usechhForm">
                <div style="margin-bottom: 2rem;">
                    <h3>Maklumat Pekerja</h3>
                    <div class="form-group">
                        <label for="usechhWorkerSelect">Pilih Pekerja *</label>
                        <select id="usechhWorkerSelect" required>
                            <option value="">-- Pilih Pekerja --</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div>
                        <h4>Section A - Maklumat Pekerjaan</h4>
                        <div class="form-group">
                            <label for="usechhJawatanSekarang">Jawatan Sekarang *</label>
                            <input type="text" id="usechhJawatanSekarang" required>
                        </div>
                        <div class="form-group">
                            <label for="usechhTempohJawatan">Tempoh Jawatan (tahun) *</label>
                            <input type="number" id="usechhTempohJawatan" step="0.1" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Bahagian Pekerjaan:</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="usechhChkPengeluaran">
                                    Pengeluaran
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="usechhChkPemasangan">
                                    Pemasangan
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="usechhChkPenyelenggaraan">
                                    Penyelenggaraan
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="usechhChkMakmal">
                                    Makmal
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="usechhChkLain">
                                    Lain-lain
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="usechhTxtLain">Sila nyatakan lain-lain:</label>
                            <input type="text" id="usechhTxtLain" disabled>
                        </div>
                    </div>

                    <div>
                        <h4>Section B - Pendedahan Kimia</h4>
                        <div class="form-group">
                            <label>Jenis Bahan Kimia:</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="usechhChkPelarutOrganik">
                                    Pelarut Organik
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="usechhChkLogamBerat">
                                    Logam Berat
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="usechhChkGasWap">
                                    Gas & Wap
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="usechhChkDebuSerat">
                                    Debu & Serat
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="usechhChkLainKimia">
                                    Lain-lain
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="usechhTempohPendedahan">Tempoh Pendedahan (jam/minggu)</label>
                            <input type="number" id="usechhTempohPendedahan" step="0.5" min="0" max="168">
                        </div>

                        <div class="form-group">
                            <label for="usechhJenisPendedahan">Jenis Pendedahan</label>
                            <select id="usechhJenisPendedahan">
                                <option value="">-- Pilih Jenis --</option>
                                <option value="PERNAFASAN">Pernafasan</option>
                                <option value="KULIT">Kulit</option>
                                <option value="PENCERNAAN">Pencernaan</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h4>Section C - Sejarah Perubatan</h4>
                    <div class="form-group">
                        <label>Gejala Semasa:</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="usechhChkSesakNafas">
                                Sesak Nafas
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="usechhChkBatukBerterusan">
                                Batuk Berterusan
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="usechhChkPeningKepala">
                                Pening Kepala
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="usechhChkMualMuntah">
                                Mual/Muntah
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="usechhChkLainGejala">
                                Lain-lain Gejala
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="usechhPenemuanDoktor">Penemuan Pemeriksaan *</label>
                        <textarea id="usechhPenemuanDoktor" rows="3" required placeholder="Catatan penemuan semasa pemeriksaan..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="usechhCadanganDoktor">Cadangan Doktor *</label>
                        <textarea id="usechhCadanganDoktor" rows="3" required placeholder="Cadangan dan nasihat doktor..."></textarea>
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h4>Tandatangan Digital</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <p><strong>Tandatangan Pekerja:</strong></p>
                            <div id="workerSignatureContainer" class="signature-container">
                                <p>Pekerja akan menandatangani melalui QR code</p>
                                <button type="button" onclick="generateWorkerQR()" class="btn btn-outline">
                                    üì± Generate QR Code
                                </button>
                                <div id="workerSignatureStatus" style="margin-top: 1rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; display: none;">
                                    <span style="color: var(--success);">‚úÖ Tandatangan telah diterima</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <p><strong>Tandatangan Doktor:</strong></p>
                            <div class="signature-container">
                                <canvas id="doctorSignatureCanvas" width="400" height="200" class="signature-canvas"></canvas>
                                <div style="margin-top: 1rem;">
                                    <button type="button" onclick="clearSignature()" class="btn btn-outline">
                                        üóëÔ∏è Padam
                                    </button>
                                    <button type="button" onclick="saveDoctorSignature()" class="btn btn-primary">
                                        üíæ Simpan Tandatangan
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" onclick="showScreen('doctorDashboard')" class="btn btn-outline">
                        Batal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span id="usechhSaveText">‚úÖ Simpan Borang USECHH</span>
                        <span id="usechhSaveLoading" class="loading" style="display: none;"></span>
                    </button>
                    <button type="button" onclick="generateUSECHHPDF()" class="btn btn-secondary">
                        üìÑ Generate PDF
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- QR SIGNATURE SCREEN -->
    <div id="qrSignatureScreen" class="screen">
        <div class="header">
            <div class="logo">
                <h1>üì± Tandatangan Digital - Pekerja</h1>
            </div>
            <div class="user-info">
                <button onclick="showScreen('usechhFormScreen')" class="btn btn-outline">Kembali</button>
            </div>
        </div>

        <div class="dashboard" style="text-align: center;">
            <div class="qr-scanner">
                <h3>Scan QR Code untuk Tandatangan</h3>
                <div id="qrCodeContainer" style="margin: 2rem 0;">
                    <img id="qrCodeImage" src="" alt="QR Code" style="max-width: 300px; border: 2px solid #ccc; padding: 1rem; background: white;">
                </div>
                <p>Scan QR code di atas dengan device anda untuk menandatangani borang</p>
                
                <div id="signaturePad" style="display: none; margin: 2rem auto; max-width: 400px;">
                    <p><strong>Silakan tandatangan di bawah:</strong></p>
                    <canvas id="mobileSignatureCanvas" width="400" height="200" 
                            style="border: 2px solid #000; background: white; touch-action: none;"></canvas>
                    <div style="margin-top: 1rem;">
                        <button type="button" onclick="clearMobileSignature()" class="btn btn-outline">Padam</button>
                        <button type="button" onclick="submitMobileSignature()" class="btn btn-primary">Hantar Tandatangan</button>
                    </div>
                </div>

                <div id="signatureSuccess" style="display: none; margin-top: 2rem; padding: 1rem; background: var(--success); color: white; border-radius: var(--radius);">
                    <h3>‚úÖ Tandatangan Berjaya!</h3>
                    <p>Tandatangan anda telah berjaya dihantar.</p>
                    <button onclick="showScreen('usechhFormScreen')" class="btn btn-outline" style="background: white; color: var(--success); margin-top: 1rem;">
                        Kembali ke Borang
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF PREVIEW SCREEN -->
    <div id="pdfPreviewScreen" class="screen">
        <div class="header">
            <div class="logo">
                <h1>üìÑ Pratonton Laporan</h1>
            </div>
            <div class="user-info">
                <button onclick="showScreen('doctorDashboard')" class="btn btn-outline">Kembali</button>
                <button onclick="downloadPDF()" class="btn btn-primary">Muat Turun PDF</button>
            </div>
        </div>

        <div class="dashboard">
            <div id="pdfPreviewContainer" style="width: 100%; height: 80vh; border: 1px solid #ccc; background: #f5f5f5; display: flex; align-items: center; justify-content: center;">
                <div style="text-align: center; padding: 2rem;">
                    <h3>PDF Preview</h3>
                    <p>PDF akan dipaparkan di sini setelah dijana</p>
                    <div id="pdfViewerIframe" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzzIqVHq5Pp5LmXB00jJ4rhQvNkCUzo8NbbFuXTzisb56voeJcLMSLP9L9CFXzpjhI/exec';
        
        // GLOBAL STATE
        let currentUser = null;
        let currentSession = null;
        let currentKlinik = null;
        let doctorSignature = null;
        let workerSignature = null;
        let currentWorkerForSignature = null;

        // INITIALIZE APP
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Medical Surveillance System Initialized');
            initializeSignatureCanvas();
            setupCheckboxListeners();
            setupEventListeners();
            setDefaultDates();
            testBackendConnection();
        });

        // SETUP EVENT LISTENERS
        function setupEventListeners() {
            // Enable/disable "Lain-lain" text field
            document.getElementById('usechhChkLain').addEventListener('change', function() {
                document.getElementById('usechhTxtLain').disabled = !this.checked;
            });
        }

        // SET DEFAULT DATES
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('examDate').value = today;
            
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                             now.getMinutes().toString().padStart(2, '0');
            document.getElementById('examTime').value = timeString;
        }

        // INITIALIZE SIGNATURE CANVAS
        function initializeSignatureCanvas() {
            const canvas = document.getElementById('doctorSignatureCanvas');
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            // Set canvas background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events for mobile
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', stopDrawing);

            function startDrawing(e) {
                isDrawing = true;
                [lastX, lastY] = getCoordinates(e);
            }

            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                
                const [currentX, currentY] = getCoordinates(e);
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(currentX, currentY);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
                
                [lastX, lastY] = [currentX, currentY];
            }

            function stopDrawing() {
                isDrawing = false;
            }

            function handleTouchStart(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }

            function handleTouchMove(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }

            function getCoordinates(e) {
                const rect = canvas.getBoundingClientRect();
                let clientX, clientY;
                
                if (e.type.includes('touch')) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                return [
                    clientX - rect.left,
                    clientY - rect.top
                ];
            }
        }

        // TEST BACKEND CONNECTION
        async function testBackendConnection() {
            try {
                const response = await fetchBackend('testConnection');
                if (response.success) {
                    console.log('‚úÖ Backend connected:', response);
                    updateSystemStatus('Connected', 'Connected', 'Connected');
                    showAlert('loginAlert', '‚úÖ Sistem sedia digunakan - DEMO MODE', 'success');
                } else {
                    console.log('‚ö†Ô∏è Using demo mode:', response.error);
                    updateSystemStatus('Demo Mode', 'Demo Mode', 'Demo Mode');
                    showAlert('loginAlert', '‚ö†Ô∏è Demo Mode - Sistem tetap berfungsi', 'success');
                }
            } catch (error) {
                console.error('Backend connection failed:', error);
                updateSystemStatus('Demo Mode', 'Demo Mode', 'Demo Mode');
                showAlert('loginAlert', '‚ö†Ô∏è Demo Mode - Sistem tetap berfungsi', 'success');
            }
        }

        // UPDATE SYSTEM STATUS
        function updateSystemStatus(backend, database, storage) {
            document.getElementById('backendStatus').textContent = backend;
            document.getElementById('databaseStatus').textContent = database;
            document.getElementById('storageStatus').textContent = storage;
        }

        // LOGIN FUNCTION
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loginBtn = document.querySelector('#loginForm button');
            const loginText = document.getElementById('loginText');
            const loginLoading = document.getElementById('loginLoading');
            
            loginText.style.display = 'none';
            loginLoading.style.display = 'inline-block';
            loginBtn.disabled = true;

            const loginData = {
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                klinikId: document.getElementById('klinikSelect').value,
                role: document.getElementById('roleSelect').value
            };

            try {
                const result = await fetchBackend('login', loginData);
                
                if (result.success) {
                    currentUser = result.user;
                    currentKlinik = {
                        id: loginData.klinikId,
                        name: result.user.klinikName
                    };
                    
                    showAlert('loginAlert', '‚úÖ Login successful!', 'success');
                    
                    // Redirect based on role
                    setTimeout(() => {
                        if (result.user.role === 'SUPER_ADMIN' || loginData.role === 'admin') {
                            showScreen('superAdminDashboard');
                            loadSuperAdminData();
                        } else if (result.user.role === 'DOCTOR' || loginData.role === 'doctor') {
                            showScreen('sessionSelectionScreen');
                            loadSessionsList();
                            document.getElementById('sessionUserRole').textContent = 'Doktor';
                        } else {
                            showScreen('sessionSelectionScreen');
                            loadSessionsList();
                            document.getElementById('sessionUserRole').textContent = 'Pembantu Perubatan';
                        }
                    }, 1000);
                    
                } else {
                    showAlert('loginAlert', '‚ùå ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('loginAlert', '‚ùå Login failed: ' + error.message, 'error');
            } finally {
                loginText.style.display = 'inline-block';
                loginLoading.style.display = 'none';
                loginBtn.disabled = false;
            }
        });

        // BACKEND API COMMUNICATION
        async function fetchBackend(action, data = {}) {
            console.log('üîß Fetching:', action, data);
            
            // Use demo mode for now due to CORS
            return generateDemoResponse(action, data);
        }

        // DEMO RESPONSE GENERATOR
        function generateDemoResponse(action, data) {
            console.log('üîß Demo mode for:', action);
            
            const demoResponses = {
                'testConnection': {
                    success: true,
                    message: '‚úÖ DEMO MODE - System Ready',
                    database: { sheets: 13, connected: true },
                    drive: { connected: true },
                    version: '1.0',
                    demo: true
                },
                'login': {
                    success: true,
                    user: {
                        userId: 'USER_DEMO_' + Math.random().toString(36).substr(2, 6).toUpperCase(),
                        name: data.role === 'admin' ? 'System Administrator' : 
                              data.role === 'doctor' ? 'Dr. Demo Doctor' : 'Demo Medical Assistant',
                        email: data.email,
                        role: data.role === 'admin' ? 'SUPER_ADMIN' : 
                              data.role === 'doctor' ? 'DOCTOR' : 'MEDICAL_ASSISTANT',
                        klinikId: data.klinikId,
                        klinikName: 'Klinik Kesihatan Utama'
                    },
                    demo: true
                },
                'getSessions': {
                    success: true,
                    sessions: [{
                        SESSION_ID: 'SESSION_2024_001',
                        SESSION_NAMA: 'Medical Surveillance 2024',
                        SYARIKAT_ID: 'Syarikat Manufacturing ABC',
                        SESSION_TARIKH_MULA: '2024-01-15',
                        SESSION_TARIKH_TAMAT: '2024-01-20',
                        SESSION_STATUS: 'IN_PROGRESS',
                        TOTAL_WORKERS: '150',
                        WORKERS_COMPLETED: '45',
                        WORKERS_PENDING: '105',
                        BATCH_NUMBER: 'BATCH-2024-01'
                    }],
                    demo: true
                },
                'getWorkers': {
                    success: true,
                    workers: [
                        {
                            WORKER_ID: 'WORKER_001',
                            PEKERJA_NAMA: 'Ahmad Bin Abdullah',
                            PEKERJA_IC: '901231045678',
                            PEKERJA_JAWATAN: 'Production Operator',
                            STATUS_PEMERIKSAAN: 'PENDING'
                        },
                        {
                            WORKER_ID: 'WORKER_002',
                            PEKERJA_NAMA: 'Siti Binti Rahman',
                            PEKERJA_IC: '880505086789',
                            PEKERJA_JAWATAN: 'Quality Control',
                            STATUS_PEMERIKSAAN: 'COMPLETED'
                        },
                        {
                            WORKER_ID: 'WORKER_003',
                            PEKERJA_NAMA: 'Raj Kumar A/L Samy',
                            PEKERJA_IC: '920715107654',
                            PEKERJA_JAWATAN: 'Technician',
                            STATUS_PEMERIKSAAN: 'PENDING'
                        }
                    ],
                    demo: true
                },
                'saveVitalSigns': {
                    success: true,
                    message: '‚úÖ Vital signs saved successfully (Demo)',
                    recordId: 'VITAL_' + Date.now(),
                    bmi: '22.5',
                    bmiCategory: 'NORMAL',
                    demo: true
                },
                'uploadLabReport': {
                    success: true, 
                    message: '‚úÖ Lab results saved successfully (Demo)',
                    demo: true
                },
                'saveUSECHHForm': {
                    success: true,
                    message: '‚úÖ USECHH form saved successfully (Demo)',
                    demo: true
                }
            };
            
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve(demoResponses[action] || { success: true, message: 'Demo action completed', demo: true });
                }, 800); // Simulate network delay
            });
        }

        // SCREEN MANAGEMENT
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show target screen
            document.getElementById(screenId).classList.add('active');
        }

        // ALERT MANAGEMENT
        function showAlert(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const alertClass = type === 'error' ? 'alert-error' : 'alert-success';
            
            container.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // LOAD SUPER ADMIN DATA
        async function loadSuperAdminData() {
            try {
                document.getElementById('adminUserName').textContent = currentUser.name;
                
                // Update system status
                updateSystemStatus('Connected', '13 sheets', 'Active');
                
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        // LOAD SESSIONS LIST
        async function loadSessionsList() {
            try {
                const result = await fetchBackend('getSessions', {
                    klinikId: currentKlinik.id
                });
                
                if (result.success) {
                    updateSessionsTable(result.sessions);
                } else {
                    loadDemoSessions();
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                loadDemoSessions();
            }
        }

        // UPDATE SESSIONS TABLE
        function updateSessionsTable(sessions) {
            const tableBody = document.querySelector('#sessionsListTable tbody');
            tableBody.innerHTML = '';
            
            sessions.forEach(session => {
                const statusClass = session.SESSION_STATUS.toLowerCase().replace('_', '-');
                const progress = Math.round((session.WORKERS_COMPLETED / session.TOTAL_WORKERS) * 100);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${session.SESSION_NAMA}</strong></td>
                    <td>${session.SYARIKAT_ID}</td>
                    <td>${formatDisplayDate(session.SESSION_TARIKH_MULA)} - ${formatDisplayDate(session.SESSION_TARIKH_TAMAT)}</td>
                    <td><span class="status-badge status-${statusClass}">${session.SESSION_STATUS}</span></td>
                    <td>${session.TOTAL_WORKERS} pekerja</td>
                    <td>
                        <div style="background: #e9ecef; border-radius: 10px; height: 8px;">
                            <div style="background: var(--primary); height: 100%; border-radius: 10px; width: ${progress}%"></div>
                        </div>
                        <small>${progress}% selesai</small>
                    </td>
                    <td>
                        <button onclick="selectSession('${session.SESSION_ID}')" class="btn btn-primary btn-sm">
                            Pilih
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // LOAD DEMO SESSIONS
        function loadDemoSessions() {
            const demoData = [
                {
                    SESSION_ID: 'SESSION_2024_001',
                    SESSION_NAMA: 'Medical Surveillance 2024',
                    SYARIKAT_ID: 'Syarikat Manufacturing ABC',
                    SESSION_TARIKH_MULA: '2024-01-15',
                    SESSION_TARIKH_TAMAT: '2024-01-20',
                    SESSION_STATUS: 'IN_PROGRESS',
                    TOTAL_WORKERS: '150',
                    WORKERS_COMPLETED: '45',
                    WORKERS_PENDING: '105'
                },
                {
                    SESSION_ID: 'SESSION_2024_002', 
                    SESSION_NAMA: 'Health Screening Q1 2024',
                    SYARIKAT_ID: 'Syarikat Elektronik XYZ',
                    SESSION_TARIKH_MULA: '2024-03-01',
                    SESSION_TARIKH_TAMAT: '2024-03-05',
                    SESSION_STATUS: 'COMPLETED',
                    TOTAL_WORKERS: '89',
                    WORKERS_COMPLETED: '89',
                    WORKERS_PENDING: '0'
                }
            ];
            
            updateSessionsTable(demoData);
        }

        // SESSION SELECTION
        async function selectSession(sessionId) {
            try {
                // For demo purposes, create session object
                currentSession = {
                    SESSION_ID: sessionId,
                    SESSION_NAMA: sessionId === 'SESSION_2024_001' ? 'Medical Surveillance 2024' : 'Health Screening Q1 2024',
                    SYARIKAT_ID: 'Syarikat Manufacturing ABC',
                    TOTAL_WORKERS: '150'
                };
                
                if (currentUser.role === 'MEDICAL_ASSISTANT' || !currentUser.role) {
                    showScreen('maDashboard');
                    loadMADashboard();
                } else if (currentUser.role === 'DOCTOR') {
                    showScreen('doctorDashboard');
                    loadDoctorDashboard();
                }
                
            } catch (error) {
                console.error('Error selecting session:', error);
            }
        }

        // LOAD MA DASHBOARD
        async function loadMADashboard() {
            try {
                document.getElementById('currentSessionName').textContent = currentSession.SESSION_NAMA;
                
                // Load workers for this session
                const workersResult = await fetchBackend('getWorkers', {
                    sessionId: currentSession.SESSION_ID
                });
                
                if (workersResult && workersResult.success) {
                    updateMAWorkersTable(workersResult.workers);
                } else {
                    loadDemoWorkers();
                }
                
            } catch (error) {
                console.error('Error loading MA dashboard:', error);
                loadDemoWorkers();
            }
        }

        // UPDATE MA WORKERS TABLE
        function updateMAWorkersTable(workers) {
            const tableBody = document.querySelector('#maWorkersTable tbody');
            tableBody.innerHTML = '';
            
            let pendingCount = 0;
            let completedCount = 0;
            let totalCount = workers.length;
            
            workers.forEach(worker => {
                const status = worker.STATUS_PEMERIKSAAN || 'PENDING';
                const statusClass = status === 'PENDING' ? 'pending' : 'completed';
                const statusText = status === 'PENDING' ? 'TERTUNGGAK' : 'SELESAI';
                
                if (status === 'PENDING') pendingCount++;
                if (status === 'COMPLETED') completedCount++;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${worker.PEKERJA_NAMA}</strong></td>
                    <td>${worker.PEKERJA_IC}</td>
                    <td>${worker.PEKERJA_JAWATAN}</td>
                    <td><span class="status-badge status-${statusClass}">${statusText}</span></td>
                    <td>${status === 'COMPLETED' ? '‚úÖ' : '‚è≥'}</td>
                    <td>${status === 'COMPLETED' ? '‚úÖ' : '‚è≥'}</td>
                    <td>
                        <button onclick="startVitalSigns('${worker.WORKER_ID}')" class="btn btn-primary btn-sm">
                            Input Vital
                        </button>
                        <button onclick="startLabInput('${worker.WORKER_ID}')" class="btn btn-secondary btn-sm" style="margin-left: 0.5rem;">
                            Lab
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Update stats
            document.getElementById('maTotalWorkers').textContent = totalCount;
            document.getElementById('maPendingVitals').textContent = pendingCount;
            document.getElementById('maCompletedVitals').textContent = completedCount;
            document.getElementById('maLabPending').textContent = pendingCount;
        }

        // LOAD DEMO WORKERS
        function loadDemoWorkers() {
            const demoWorkers = [
                {
                    WORKER_ID: 'WORKER_001',
                    PEKERJA_NAMA: 'Ahmad Bin Abdullah',
                    PEKERJA_IC: '901231045678',
                    PEKERJA_JAWATAN: 'Production Operator',
                    STATUS_PEMERIKSAAN: 'PENDING'
                },
                {
                    WORKER_ID: 'WORKER_002',
                    PEKERJA_NAMA: 'Siti Binti Rahman', 
                    PEKERJA_IC: '880505086789',
                    PEKERJA_JAWATAN: 'Quality Control',
                    STATUS_PEMERIKSAAN: 'COMPLETED'
                },
                {
                    WORKER_ID: 'WORKER_003',
                    PEKERJA_NAMA: 'Raj Kumar A/L Samy',
                    PEKERJA_IC: '920715107654',
                    PEKERJA_JAWATAN: 'Technician',
                    STATUS_PEMERIKSAAN: 'PENDING'
                },
                {
                    WORKER_ID: 'WORKER_004',
                    PEKERJA_NAMA: 'Mei Ling Binti Tan',
                    PEKERJA_IC: '890909087321',
                    PEKERJA_JAWATAN: 'Supervisor',
                    STATUS_PEMERIKSAAN: 'PENDING'
                }
            ];
            
            updateMAWorkersTable(demoWorkers);
        }

        // VITAL SIGNS MANAGEMENT
        async function showVitalSignsScreen() {
            showScreen('vitalSignsScreen');
            await loadWorkersForVitals();
        }

        async function loadWorkersForVitals() {
            try {
                const workersResult = await fetchBackend('getWorkers', {
                    sessionId: currentSession.SESSION_ID
                });
                
                const workerSelect = document.getElementById('workerSelect');
                workerSelect.innerHTML = '<option value="">-- Pilih Pekerja --</option>';
                
                const workers = workersResult && workersResult.success ? workersResult.workers : [
                    { WORKER_ID: 'WORKER_001', PEKERJA_NAMA: 'Ahmad Bin Abdullah', PEKERJA_IC: '901231045678' },
                    { WORKER_ID: 'WORKER_002', PEKERJA_NAMA: 'Siti Binti Rahman', PEKERJA_IC: '880505086789' },
                    { WORKER_ID: 'WORKER_003', PEKERJA_NAMA: 'Raj Kumar A/L Samy', PEKERJA_IC: '920715107654' }
                ];
                
                workers.forEach(worker => {
                    const option = document.createElement('option');
                    option.value = worker.WORKER_ID;
                    option.textContent = `${worker.PEKERJA_NAMA} (${worker.PEKERJA_IC})`;
                    workerSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading workers:', error);
            }
        }

        // SAVE VITAL SIGNS
        document.getElementById('vitalSignsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const saveBtn = document.querySelector('#vitalSignsForm button[type="submit"]');
            const saveText = document.getElementById('vitalSaveText');
            const saveLoading = document.getElementById('vitalSaveLoading');
            
            saveText.style.display = 'none';
            saveLoading.style.display = 'inline-block';
            saveBtn.disabled = true;

            const formData = {
                WORKER_ID: document.getElementById('workerSelect').value,
                SESSION_ID: currentSession.SESSION_ID,
                KLINIK_ID: currentKlinik.id,
                MA_ID: currentUser.userId || 'MA_DEMO',
                VITAL_TINGGI: document.getElementById('vitalTinggi').value,
                VITAL_BERAT: document.getElementById('vitalBerat').value,
                VITAL_BP_SISTOLIK: document.getElementById('vitalBpSistolik').value,
                VITAL_BP_DIASTOLIK: document.getElementById('vitalBpDiastolik').value,
                VITAL_PULSE_RATE: document.getElementById('vitalPulse').value,
                VITAL_SPO2: document.getElementById('vitalSpo2').value,
                VITAL_SUHU: document.getElementById('vitalSuhu').value,
                TARIKH_PEMERIKSAAN: document.getElementById('examDate').value,
                MASA_PEMERIKSAAN: document.getElementById('examTime').value,
                MATA_VISUAL_ACUITY_KANAN: document.getElementById('mataVisualAcuityKanan').value,
                MATA_VISUAL_ACUITY_KIRI: document.getElementById('mataVisualAcuityKiri').value,
                MATA_ISHIHARA_TEST: document.getElementById('mataIshiharaTest').value,
                TIANG_BUNYI_KANAN: document.getElementById('tiangBunyiKanan').value,
                TIANG_BUNYI_KIRI: document.getElementById('tiangBunyiKiri').value,
                PARU_PARU_PEMERIKSAAN: document.getElementById('paruPemeriksaan').value,
                JANTUNG_PEMERIKSAAN: document.getElementById('jantungPemeriksaan').value,
                NOTES: document.getElementById('physicalExamNotes').value
            };

            try {
                const result = await fetchBackend('saveVitalSigns', formData);
                
                if (result && result.success) {
                    alert('‚úÖ Vital signs saved successfully!');
                    showScreen('maDashboard');
                    loadMADashboard();
                } else {
                    alert('‚úÖ Vital signs demo saved!');
                    showScreen('maDashboard');
                    loadMADashboard();
                }
            } catch (error) {
                console.error('Error saving vital signs:', error);
                alert('‚úÖ Vital signs demo saved! (Offline mode)');
                showScreen('maDashboard');
                loadMADashboard();
            } finally {
                saveText.style.display = 'inline-block';
                saveLoading.style.display = 'none';
                saveBtn.disabled = false;
            }
        });

        // LAB REVIEW MANAGEMENT
        async function showLabReviewScreen() {
            showScreen('labReviewScreen');
            await loadWorkersForLab();
        }

        function startLabInput(workerId) {
            showScreen('labReviewScreen');
            loadWorkersForLab().then(() => {
                document.getElementById('labWorkerSelect').value = workerId;
            });
        }

        async function loadWorkersForLab() {
            try {
                const workersResult = await fetchBackend('getWorkers', {
                    sessionId: currentSession.SESSION_ID
                });
                
                const workerSelect = document.getElementById('labWorkerSelect');
                workerSelect.innerHTML = '<option value="">-- Pilih Pekerja --</option>';
                
                const workers = workersResult && workersResult.success ? workersResult.workers : [
                    { WORKER_ID: 'WORKER_001', PEKERJA_NAMA: 'Ahmad Bin Abdullah', PEKERJA_IC: '901231045678' },
                    { WORKER_ID: 'WORKER_002', PEKERJA_NAMA: 'Siti Binti Rahman', PEKERJA_IC: '880505086789' }
                ];
                
                workers.forEach(worker => {
                    const option = document.createElement('option');
                    option.value = worker.WORKER_ID;
                    option.textContent = `${worker.PEKERJA_NAMA} (${worker.PEKERJA_IC})`;
                    workerSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading workers for lab:', error);
            }
        }

        // UPLOAD LAB PDF
        async function uploadLabPDF() {
            const fileInput = document.getElementById('labPdfUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Sila pilih fail PDF terlebih dahulu');
                return;
            }

            if (file.type !== 'application/pdf') {
                alert('Sila pilih fail PDF sahaja');
                return;
            }

            try {
                // Simulate PDF upload
                alert('‚úÖ PDF lab report uploaded successfully! (Demo)');
                document.getElementById('pdfViewer').style.display = 'block';
                document.getElementById('pdfViewer').innerHTML = `
                    <div style="padding: 2rem; text-align: center;">
                        <h4>üìÑ Lab Report Preview</h4>
                        <p>File: ${file.name}</p>
                        <p>Size: ${(file.size / 1024).toFixed(2)} KB</p>
                        <p style="color: var(--success); margin-top: 1rem;">‚úÖ PDF berjaya diupload</p>
                    </div>
                `;
                
            } catch (error) {
                alert('‚ùå Failed to upload PDF: ' + error.message);
            }
        }

        // SAVE LAB RESULTS
        document.getElementById('labResultsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const saveBtn = document.querySelector('#labResultsForm button[type="submit"]');
            const saveText = document.getElementById('labSaveText');
            const saveLoading = document.getElementById('labSaveLoading');
            
            saveText.style.display = 'none';
            saveLoading.style.display = 'inline-block';
            saveBtn.disabled = true;

            const formData = {
                WORKER_ID: document.getElementById('labWorkerSelect').value,
                SESSION_ID: currentSession.SESSION_ID,
                KLINIK_ID: currentKlinik.id,
                MA_ID: currentUser.userId || 'MA_DEMO',
                LAB_HB_VALUE: document.getElementById('labHb').value,
                LAB_HB_STATUS: 'NORMAL',
                LAB_WBC_VALUE: document.getElementById('labWbc').value,
                LAB_WBC_STATUS: 'NORMAL',
                LAB_PLATELET_VALUE: document.getElementById('labPlatelet').value,
                LAB_PLATELET_STATUS: 'NORMAL',
                LAB_FBS_VALUE: document.getElementById('labFbs').value,
                LAB_FBS_STATUS: 'NORMAL',
                LAB_KATEGORI: document.getElementById('labKategori').value,
                LAB_REMARKS_MA: document.getElementById('labRemarks').value
            };

            try {
                const result = await fetchBackend('uploadLabReport', formData);
                
                if (result && result.success) {
                    alert('‚úÖ Lab results saved successfully!');
                    showScreen('maDashboard');
                    loadMADashboard();
                } else {
                    alert('‚úÖ Lab results demo saved!');
                    showScreen('maDashboard');
                    loadMADashboard();
                }
            } catch (error) {
                console.error('Error saving lab results:', error);
                alert('‚úÖ Lab results demo saved! (Offline mode)');
                showScreen('maDashboard');
                loadMADashboard();
            } finally {
                saveText.style.display = 'inline-block';
                saveLoading.style.display = 'none';
                saveBtn.disabled = false;
            }
        });

        // START VITAL SIGNS FOR SPECIFIC WORKER
        function startVitalSigns(workerId) {
            showScreen('vitalSignsScreen');
            loadWorkersForVitals().then(() => {
                document.getElementById('workerSelect').value = workerId;
            });
        }

        // EXPORT FUNCTIONALITY
        async function exportMAReport() {
            try {
                const result = await fetchBackend('generatePDF', {
                    sessionId: currentSession.SESSION_ID,
                    reportType: 'MA_SUMMARY',
                    klinikId: currentKlinik.id
                });
                
                if (result && result.success) {
                    window.open(result.pdfUrl, '_blank');
                } else {
                    // Demo PDF generation
                    alert('üìÑ Laporan MA sedang dijana... (Demo)');
                    setTimeout(() => {
                        window.open('https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', '_blank');
                    }, 1000);
                }
            } catch (error) {
                console.error('Error exporting report:', error);
                alert('üìÑ Laporan MA sedang dijana... (Demo)');
                setTimeout(() => {
                    window.open('https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', '_blank');
                }, 1000);
            }
        }

        // DOCTOR DASHBOARD FUNCTIONS
        async function loadDoctorDashboard() {
            try {
                document.getElementById('doctorSessionName').textContent = currentSession.SESSION_NAMA;
                document.getElementById('doctorName').textContent = currentUser.name || 'Dr. Demo Doctor';
                
                // Load demo data for doctor dashboard
                loadDemoDoctorData();
                
            } catch (error) {
                console.error('Error loading doctor dashboard:', error);
                loadDemoDoctorData();
            }
        }

        function loadDemoDoctorData() {
            // Update stats
            document.getElementById('doctorTotalWorkers').textContent = '45';
            document.getElementById('doctorPendingReview').textContent = '12';
            document.getElementById('doctorCompletedReview').textContent = '33';
            document.getElementById('doctorAbnormalCases').textContent = '3';
            
            // Load demo workers table
            const tableBody = document.querySelector('#doctorWorkersTable tbody');
            tableBody.innerHTML = '';
            
            const demoWorkers = [
                {
                    PEKERJA_NAMA: 'Ahmad Bin Abdullah',
                    PEKERJA_IC: '901231045678',
                    VITAL_SIGNS: '‚úÖ Completed',
                    LAB_RESULTS: '‚úÖ Completed', 
                    STATUS: 'PENDING REVIEW'
                },
                {
                    PEKERJA_NAMA: 'Siti Binti Rahman',
                    PEKERJA_IC: '880505086789',
                    VITAL_SIGNS: '‚úÖ Completed',
                    LAB_RESULTS: '‚úÖ Completed',
                    STATUS: 'COMPLETED'
                },
                {
                    PEKERJA_NAMA: 'Raj Kumar A/L Samy',
                    PEKERJA_IC: '920715107654',
                    VITAL_SIGNS: '‚úÖ Completed',
                    LAB_RESULTS: '‚ö†Ô∏è Abnormal',
                    STATUS: 'PENDING REVIEW'
                }
            ];
            
            demoWorkers.forEach(worker => {
                const statusClass = worker.STATUS === 'PENDING REVIEW' ? 'pending' : 'completed';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${worker.PEKERJA_NAMA}</strong></td>
                    <td>${worker.PEKERJA_IC}</td>
                    <td>${worker.VITAL_SIGNS}</td>
                    <td>${worker.LAB_RESULTS}</td>
                    <td><span class="status-badge status-${statusClass}">${worker.STATUS}</span></td>
                    <td>
                        <button onclick="startUSECHHFormForWorker('${worker.PEKERJA_IC}')" class="btn btn-primary btn-sm">
                            Review
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // START USECHH FORM
        function startUSECHHForm() {
            showScreen('usechhFormScreen');
            loadWorkersForUSECHH();
        }

        function startUSECHHFormForWorker(workerIC) {
            showScreen('usechhFormScreen');
            loadWorkersForUSECHH().then(() => {
                // Find and select the worker
                const select = document.getElementById('usechhWorkerSelect');
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].textContent.includes(workerIC)) {
                        select.selectedIndex = i;
                        break;
                    }
                }
            });
        }

        async function loadWorkersForUSECHH() {
            const workerSelect = document.getElementById('usechhWorkerSelect');
            workerSelect.innerHTML = '<option value="">-- Pilih Pekerja --</option>';
            
            const demoWorkers = [
                { WORKER_ID: 'WORKER_001', PEKERJA_NAMA: 'Ahmad Bin Abdullah', PEKERJA_IC: '901231045678' },
                { WORKER_ID: 'WORKER_002', PEKERJA_NAMA: 'Siti Binti Rahman', PEKERJA_IC: '880505086789' },
                { WORKER_ID: 'WORKER_003', PEKERJA_NAMA: 'Raj Kumar A/L Samy', PEKERJA_IC: '920715107654' }
            ];
            
            demoWorkers.forEach(worker => {
                const option = document.createElement('option');
                option.value = worker.WORKER_ID;
                option.textContent = `${worker.PEKERJA_NAMA} (${worker.PEKERJA_IC})`;
                workerSelect.appendChild(option);
            });
        }

        // CLEAR SIGNATURE
        function clearSignature() {
            const canvas = document.getElementById('doctorSignatureCanvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            doctorSignature = null;
        }

        // SAVE DOCTOR SIGNATURE
        function saveDoctorSignature() {
            const canvas = document.getElementById('doctorSignatureCanvas');
            doctorSignature = canvas.toDataURL();
            alert('‚úÖ Tandatangan doktor disimpan!');
        }

        // GENERATE WORKER QR CODE
        function generateWorkerQR() {
            const workerSelect = document.getElementById('usechhWorkerSelect');
            const workerId = workerSelect.value;
            
            if (!workerId) {
                alert('‚ùå Sila pilih pekerja terlebih dahulu');
                return;
            }

            currentWorkerForSignature = workerId;
            
            // Generate QR code URL (using a free QR code service)
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=MEDSIGN-${workerId}-${Date.now()}`;
            
            document.getElementById('qrCodeImage').src = qrUrl;
            document.getElementById('signaturePad').style.display = 'block';
            showScreen('qrSignatureScreen');
        }

        // CLEAR MOBILE SIGNATURE
        function clearMobileSignature() {
            const canvas = document.getElementById('mobileSignatureCanvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // SUBMIT MOBILE SIGNATURE
        function submitMobileSignature() {
            const canvas = document.getElementById('mobileSignatureCanvas');
            workerSignature = canvas.toDataURL();
            
            // Show success message
            document.getElementById('signaturePad').style.display = 'none';
            document.getElementById('signatureSuccess').style.display = 'block';
            
            // Update the main form
            setTimeout(() => {
                document.getElementById('workerSignatureStatus').style.display = 'block';
            }, 1000);
        }

        // SAVE USECHH FORM
        document.getElementById('usechhForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const saveBtn = document.querySelector('#usechhForm button[type="submit"]');
            const saveText = document.getElementById('usechhSaveText');
            const saveLoading = document.getElementById('usechhSaveLoading');
            
            saveText.style.display = 'none';
            saveLoading.style.display = 'inline-block';
            saveBtn.disabled = true;

            if (!doctorSignature) {
                alert('‚ùå Sila simpan tandatangan doktor terlebih dahulu');
                saveText.style.display = 'inline-block';
                saveLoading.style.display = 'none';
                saveBtn.disabled = false;
                return;
            }

            const formData = {
                WORKER_ID: document.getElementById('usechhWorkerSelect').value,
                SESSION_ID: currentSession.SESSION_ID,
                DOCTOR_ID: currentUser.userId || 'DOCTOR_DEMO',
                KLINIK_ID: currentKlinik.id,
                USECHH_A_JAWATAN_SEKARANG: document.getElementById('usechhJawatanSekarang').value,
                USECHH_A_TEMPOH_JAWATAN: document.getElementById('usechhTempohJawatan').value,
                USECHH_A_CHK_BAHAGIAN_PENGELUARAN: document.getElementById('usechhChkPengeluaran').checked,
                USECHH_A_CHK_BAHAGIAN_PEMASANGAN: document.getElementById('usechhChkPemasangan').checked,
                USECHH_A_CHK_BAHAGIAN_PENYELENGGARAAN: document.getElementById('usechhChkPenyelenggaraan').checked,
                USECHH_A_CHK_BAHAGIAN_MAKMAL: document.getElementById('usechhChkMakmal').checked,
                USECHH_A_CHK_BAHAGIAN_LAIN: document.getElementById('usechhChkLain').checked,
                USECHH_A_TXT_BAHAGIAN_LAIN: document.getElementById('usechhTxtLain').value,
                USECHH_B_CHK_PELARUT_ORGANIK: document.getElementById('usechhChkPelarutOrganik').checked,
                USECHH_B_CHK_LOGAM_BERAT: document.getElementById('usechhChkLogamBerat').checked,
                USECHH_B_CHK_GAS_WAP: document.getElementById('usechhChkGasWap').checked,
                USECHH_B_CHK_DEBU_SERAT: document.getElementById('usechhChkDebuSerat').checked,
                USECHH_B_TEMPOH_PENDEDAHAN: document.getElementById('usechhTempohPendedahan').value,
                USECHH_B_JENIS_PENDEDAHAN: document.getElementById('usechhJenisPendedahan').value,
                USECHH_C_CHK_SESAK_NAFAS: document.getElementById('usechhChkSesakNafas').checked,
                USECHH_C_CHK_BATUK_BERTERUSAN: document.getElementById('usechhChkBatukBerterusan').checked,
                USECHH_C_CHK_PENING_KEPALA: document.getElementById('usechhChkPeningKepala').checked,
                USECHH_C_CHK_MUAL_MUNTAH: document.getElementById('usechhChkMualMuntah').checked,
                USECHH_C_PENEMUAN_DOKTOR: document.getElementById('usechhPenemuanDoktor').value,
                USECHH_C_CADANGAN_DOKTOR: document.getElementById('usechhCadanganDoktor').value,
                TANDATANGAN_DOKTOR_URL: doctorSignature,
                TANDATANGAN_PEKERJA_URL: workerSignature || ''
            };

            try {
                const result = await fetchBackend('saveUSECHHForm', formData);
                
                if (result && result.success) {
                    alert('‚úÖ Borang USECHH berjaya disimpan!');
                    showScreen('doctorDashboard');
                    loadDoctorDashboard();
                } else {
                    alert('‚úÖ Borang USECHH demo disimpan!');
                    showScreen('doctorDashboard');
                    loadDoctorDashboard();
                }
            } catch (error) {
                console.error('Error saving USECHH form:', error);
                alert('‚úÖ Borang USECHH demo disimpan! (Offline mode)');
                showScreen('doctorDashboard');
                loadDoctorDashboard();
            } finally {
                saveText.style.display = 'inline-block';
                saveLoading.style.display = 'none';
                saveBtn.disabled = false;
            }
        });

        // GENERATE USECHH PDF
        function generateUSECHHPDF() {
            alert('üìÑ Menjana PDF Borang USECHH... (Demo)');
            showScreen('pdfPreviewScreen');
            
            // Simulate PDF generation
            setTimeout(() => {
                document.getElementById('pdfPreviewContainer').innerHTML = `
                    <div style="padding: 2rem; text-align: center;">
                        <h3>Borang USECHH - Pratonton</h3>
                        <p>PDF telah berjaya dijana untuk pekerja yang dipilih</p>
                        <div style="margin: 2rem 0; padding: 1rem; background: white; border-radius: var(--radius); box-shadow: var(--shadow);">
                            <h4>BORANG PENILAIAN KESIHATAN PEKERJA (USECHH)</h4>
                            <p>Pekerja: ${document.getElementById('usechhWorkerSelect').selectedOptions[0]?.textContent || 'N/A'}</p>
                            <p>Doktor: ${currentUser.name || 'Dr. Demo Doctor'}</p>
                            <p>Tarikh: ${new Date().toLocaleDateString('ms-MY')}</p>
                        </div>
                        <button onclick="downloadPDF()" class="btn btn-primary">Muat Turun PDF</button>
                    </div>
                `;
            }, 1500);
        }

        // DOWNLOAD PDF
        function downloadPDF() {
            alert('üì• Memuat turun PDF... (Demo)');
            // In real implementation, this would download the actual PDF
            setTimeout(() => {
                alert('‚úÖ PDF berjaya dimuat turun!');
            }, 1000);
        }

        // OTHER DOCTOR FUNCTIONS
        function generateMedicalReport() {
            alert('üìä Menjana laporan perubatan... (Demo)');
        }

        function reviewAbnormalCases() {
            alert('üö® Membuka senarai kes abnormal... (Demo)');
        }

        function exportDoctorReport() {
            alert('üìà Mengeksport laporan doktor... (Demo)');
        }

        // ADMIN FUNCTIONS
        function createNewSession() {
            alert('üÜï Membuat session baru... (Demo)');
        }

        function generateSystemReport() {
            alert('üìà Menjana laporan sistem... (Demo)');
        }

        // UTILITY FUNCTIONS
        function formatDisplayDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('ms-MY');
        }

        // LOGOUT FUNCTION
        function logout() {
            currentUser = null;
            currentSession = null;
            currentKlinik = null;
            doctorSignature = null;
            workerSignature = null;
            
            // Clear form fields
            document.getElementById('loginForm').reset();
            clearSignature();
            
            showScreen('loginScreen');
        }

        // DEMO FUNCTIONS
        function showBulkUploadScreen() {
            alert('üìÅ Bulk upload feature (Demo)');
        }

        function showDigitalSignature() {
            alert('‚úçÔ∏è Digital signature tools (Demo)');
        }

        function showQRGenerator() {
            alert('üì± QR code generator (Demo)');
        }

        function showTemplateManager() {
            alert('üìã Template manager (Demo)');
        }

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
        });

    </script>

</body>
</html>
